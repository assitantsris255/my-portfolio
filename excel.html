<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing System - Admin & User</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
    
    /* Login Screen */
    .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
    .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 350px; }
    .login-card h1 { font-size: 24px; margin-bottom: 20px; text-align: center; color: #667eea; }
    .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
    .login-card button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .login-card button:hover { background: #764ba2; }
    .login-card .role-select { margin-top: 10px; }
    
    /* Header */
    header { background: #667eea; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-wrap: wrap; }
    header h1 { font-size: 20px; }
    .menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
    header .user-info { display: flex; gap: 15px; align-items: center; font-size: 14px; flex-wrap: wrap; }
    header button:not(.menu-toggle) { background: #ff4757; padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 13px; }
    
    /* Main Layout */
    .container { display: flex; height: calc(100vh - 60px); }
    .sidebar { width: 200px; background: #2c3e50; color: white; padding: 15px; overflow-y: auto; transition: transform 0.3s ease; }
    .sidebar button { width: 100%; padding: 14px; margin: 8px 0; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .sidebar button.active { background: #667eea; }
    .sidebar button:hover { background: #667eea; }
    
    /* Main Content */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5; }
    
    /* Dashboard */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-card h3 { color: #667eea; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
    .stat-card .number { font-size: 28px; font-weight: bold; color: #333; }
    
    /* Invoice Form */
    .form-section { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 15px; }
    .form-section h2 { font-size: 16px; margin-bottom: 10px; color: #000; border-bottom: 3px solid #667eea; padding-bottom: 8px; font-weight: bold; text-transform: uppercase; }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 14px; margin-bottom: 4px; font-weight: bold; color: #000; text-transform: uppercase; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #333; border-radius: 4px; font-size: 16px; font-weight: bold; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; background: white; margin: 15px 0; font-size: 15px; font-weight: bold; }
    thead { background: #667eea; color: white; font-weight: bold; font-size: 15px; }
    th, td { padding: 12px; text-align: left; font-size: 15px; font-weight: bold; border-bottom: 2px solid #333; }
    tbody tr { font-weight: bold; }
    tbody td { font-weight: bold; font-size: 15px; }
    tbody tr:hover { background: #f0f0f0; }
    .delete-btn { background: #ff4757; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    
    /* Controls */
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
    .controls button { padding: 12px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .controls button:hover { background: #764ba2; }
    .controls button.danger { background: #ff4757; }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 700px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 95vh; overflow-y: auto; }
    .modal-content h2 { margin-bottom: 15px; font-size: 18px; color: #333; }
    .modal-close { position: absolute; top: 15px; right: 15px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; }
    
    /* Overlay for mobile menu */
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 499; }
    .sidebar-overlay.show { display: block; }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .menu-toggle { display: block; }
      header { gap: 10px; }
      header h1 { font-size: 18px; }
      header .user-info { font-size: 12px; gap: 10px; }
      
      .container { flex-direction: column; height: auto; }
      .sidebar { 
        position: fixed; 
        left: 0; 
        top: 60px; 
        height: calc(100vh - 60px); 
        width: 250px; 
        z-index: 500;
        transform: translateX(-100%);
      }
      .sidebar.show { transform: translateX(0); }
      
      .main-content { 
        width: 100%; 
        padding: 15px; 
        margin-left: 0;
      }
      
      .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
      .stat-card { padding: 15px; }
      .stat-card h3 { font-size: 11px; }
      .stat-card .number { font-size: 22px; }
      
      .form-group input, .form-group select { padding: 12px; font-size: 16px; }
      
      table { font-size: 13px; }
      th, td { padding: 10px; font-size: 13px; }
      .delete-btn { padding: 6px 10px; font-size: 11px; }
      
      .controls { gap: 8px; }
      .controls button { padding: 12px 12px; font-size: 12px; }
      
      .modal-content { padding: 15px; }
      .modal-close { width: 35px; height: 35px; font-size: 18px; }
      
      .invoice-preview { width: 100% !important; }
    }
    
    @media (max-width: 480px) {
      header h1 { font-size: 16px; }
      header .user-info { font-size: 11px; gap: 5px; }
      header button:not(.menu-toggle) { padding: 8px 10px; font-size: 11px; }
      
      .dashboard-grid { grid-template-columns: 1fr; }
      
      .form-section { padding: 12px; }
      .form-section h2 { font-size: 14px; }
      .form-group label { font-size: 12px; }
      .form-group input, .form-group select { padding: 12px; font-size: 16px; }
      
      table { font-size: 12px; }
      th, td { padding: 8px; font-size: 12px; }
      .delete-btn { padding: 6px 8px; }
      
      .controls { gap: 5px; }
      .controls button { padding: 10px 12px; font-size: 11px; }
      
      .modal-content { padding: 12px; }
      .modal-close { width: 32px; height: 32px; font-size: 16px; }
    }
    
    /* Print Styles */
    @media print {
      body { background: white; }
      header, .sidebar, .controls, .delete-btn, .menu-toggle { display: none; }
      .main-content { padding: 0; width: 50mm; }
      table { width: 100%; }
      th, td { padding: 3px; font-size: 8px; }
      .invoice-preview { page-break-after: always; width: 50mm; padding: 5px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen" class="login-screen">
  <div class="login-card">
    <h1>Billing System</h1>
    <input type="text" id="username-input" placeholder="Username" />
    <input type="password" id="password-input" placeholder="Password" />
    <div class="role-select">
      <label style="color: #333; font-size: 13px; margin-bottom: 5px; display: block;">Role:</label>
      <select id="role-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- Header -->
<header id="header" style="display: none;">
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
  <h1>Billing System</h1>
  <div class="user-info">
    <span>User: <strong id="current-user">User</strong></span>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<!-- Main Container -->
<div id="main-container" class="container" style="display: none;">
  
  <!-- Sidebar Overlay for mobile -->
  <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar">
    <button class="nav-btn active" data-section="dashboard">üìä Dashboard</button>
    <button class="nav-btn" data-section="products">üì¶ Products</button>
    <button class="nav-btn" data-section="billing">üìù Billing</button>
    <button class="nav-btn" data-section="invoices">üìã Invoices</button>
    <button id="admin-btn" class="nav-btn" data-section="admin" style="display: none;">‚öôÔ∏è Admin Panel</button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <h2 style="font-size: 20px; margin-bottom: 20px; color: #333;">Dashboard</h2>
      
      <div class="dashboard-grid">
        <div class="stat-card">
          <h3>Total Revenue</h3>
          <div class="number" id="total-revenue">0.00</div>
        </div>
        <div class="stat-card">
          <h3>Total Invoices</h3>
          <div class="number" id="total-invoices">0</div>
        </div>
        <div class="stat-card">
          <h3>This Month</h3>
          <div class="number" id="month-revenue">0.00</div>
        </div>
        <div class="stat-card">
          <h3>Average Invoice</h3>
          <div class="number" id="avg-invoice">0.00</div>
        </div>
      </div>

      <div class="form-section">
        <h2>Recent Transactions</h2>
        <table id="recent-table">
          <thead>
            <tr><th>Date</th><th>Customer</th><th>Amount</th><th>Method</th></tr>
          </thead>
          <tbody id="recent-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Billing Section -->
    <div id="billing-section" class="section" style="display: none;">
      <h2 style="font-size: 20px; margin-bottom: 10px; color: #333;">Create Invoice</h2>
      <div style="background: #667eea; color: white; padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; font-weight: bold; font-size: 16px; text-align: center;">
        Shop: <span id="bill-shop-name">Your Shop</span>
      </div>
      
      <div class="form-section">
        <h2>Shop Name</h2>
        <div class="form-group">
          <label>Update Shop Name</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="billing-shop-name" placeholder="Enter your shop name" style="flex: 1;" />
            <button onclick="updateBillingShopName()" style="padding: 12px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Update</button>
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <h2>Customer Details</h2>
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="cust-name" placeholder="Enter name" />
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="cust-addr" placeholder="Enter address" />
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="invoice-date" />
        </div>
      </div>

      <div class="form-section">
        <h2>Items</h2>
        <div class="form-group" style="margin-bottom: 10px;">
          <label>Select Category</label>
          <div style="display: flex; gap: 10px;">
            <select id="item-category-filter" onchange="filterItemsByCategory()" style="flex: 1; padding: 12px; border: 2px solid #333; border-radius: 4px; font-weight: bold; font-size: 16px;">
              <option value="">All Categories</option>
            </select>
            <input type="text" id="item-search" placeholder="Search item..." onkeyup="filterItemsBySearch()" style="flex: 1; padding: 12px; border: 2px solid #333; border-radius: 4px; font-weight: bold; font-size: 16px;" />
          </div>
        </div>
        <table>
          <thead><tr><th>#</th><th>Product Name</th><th>Category</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr></thead>
          <tbody id="items-body"></tbody>
        </table>
        <button class="controls" onclick="addItem()" style="margin-top: 10px; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">+ Add Item</button>
      </div>

      <div class="form-section">
        <h2>Summary</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
          <tr style="border: 2px solid #333; background: #f0f0f0;">
            <td style="padding: 12px; font-size: 16px; font-weight: bold;">TOTAL</td>
            <td style="text-align: right; padding: 12px; font-size: 18px; font-weight: bold; color: #d63031;" id="final-total">0.00</td>
          </tr>
        </table>

        <div class="form-group" style="margin-top: 15px;">
          <label style="font-size: 15px; font-weight: bold;">Payment Method</label>
          <select id="payment-method">
            <option>Cash</option>
            <option>Bank Transfer</option>
            <option>Card</option>
            <option>Mobile Money</option>
          </select>
        </div>

        <div class="form-group" style="margin-top: 15px;">
          <label style="font-size: 15px; font-weight: bold;">Paid Amount</label>
          <input type="number" id="paid-amount" placeholder="0.00" min="0" step="0.01" onchange="calcPaidUnpaid()" style="font-size: 16px;" />
        </div>

        <div class="form-group" style="margin-top: 15px;">
          <label style="font-size: 15px; font-weight: bold;">Unpaid Amount</label>
          <input type="number" id="unpaid-amount" placeholder="0.00" min="0" step="0.01" readonly style="font-size: 16px; background: #f0f0f0;" />
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 4px;">
          <strong style="font-size: 15px; color: #27ae60;">Payment Status:</strong>
          <div id="payment-status" style="font-size: 14px; color: #333; margin-top: 5px; font-weight: bold;">Pending</div>
        </div>
      </div>

      <div class="controls">
        <button onclick="generateInvoice()" style="background: #27ae60;">Print Invoice</button>
        <button onclick="saveInvoice()" style="background: #667eea;">Save & Complete</button>
        <button onclick="clearForm()" style="background: #95a5a6;">Clear</button>
      </div>
    </div>

    <!-- Invoices Section -->
    <div id="invoices-section" class="section" style="display: none;">
      <h2 style="font-size: 20px; margin-bottom: 20px; color: #333;">Invoice History</h2>
      
      <div class="form-section">
        <table>
          <thead>
            <tr><th>Date</th><th>Customer</th><th>Amount</th><th>Method</th><th>Action</th></tr>
          </thead>
          <tbody id="invoices-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Products Section -->
    <div id="products-section" class="section" style="display: none;">
      <h2 style="font-size: 20px; margin-bottom: 20px; color: #333;">Product Management</h2>
      
      <div class="form-section">
        <h2>Add New Product</h2>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="product-name" placeholder="Enter product name" />
        </div>
        <div class="form-group">
          <label>Product Code</label>
          <input type="text" id="product-code" placeholder="e.g., PROD-001" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="product-desc" placeholder="Product description" />
        </div>
        <div class="form-group">
          <label>Unit Price</label>
          <input type="number" id="product-price" placeholder="0.00" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" id="product-stock" placeholder="0" min="0" />
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="product-category" placeholder="Product category" />
        </div>
        <div class="controls">
          <button onclick="addProduct()" style="background: #27ae60;">+ Add Product</button>
          <button onclick="clearProductForm()" style="background: #95a5a6;">Clear</button>
        </div>
      </div>

      <div class="form-section">
        <h2>Your Products</h2>
        <table>
          <thead>
            <tr><th>Code</th><th>Name</th><th>Price</th><th>Stock</th><th>Category</th><th>Action</th></tr>
          </thead>
          <tbody id="products-body"></tbody>
        </table>
        <div id="no-products-message" style="padding: 15px; text-align: center; color: #666; font-weight: bold;">
          No products yet. Add a product above.
        </div>
      </div>

      <div class="form-section">
        <h2>Low Stock Alert</h2>
        <table>
          <thead>
            <tr><th>Product</th><th>Current Stock</th><th>Reorder Level</th><th>Needed</th></tr>
          </thead>
          <tbody id="low-stock-body"></tbody>
        </table>
        <div id="no-low-stock-message" style="padding: 15px; text-align: center; color: #27ae60; font-weight: bold;">
          ‚úÖ All products have adequate stock.
        </div>
      </div>
    </div>

    <!-- Admin Panel Section -->
    <div id="admin-section" class="section" style="display: none;">
      <h2 style="font-size: 20px; margin-bottom: 20px; color: #333;">Admin Panel</h2>

      <div class="form-section">
        <h2>Shop Settings</h2>
        <div class="form-group">
          <label>Shop Name</label>
          <input type="text" id="shop-name-input" placeholder="Enter your shop name" style="font-size: 16px; padding: 10px; border: 2px solid #333;">
          <button onclick="saveShopName()" style="margin-top: 10px; padding: 10px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Save Shop Name</button>
        </div>
        <p style="margin-top: 10px; font-size: 14px; font-weight: bold;">Current: <span id="current-shop-name" style="color: #667eea;">Not Set</span></p>
      </div>

      <div class="form-section">
        <h2>User Management (Supabase)</h2>
        <div style="padding: 10px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 4px; margin-bottom: 15px; color: #856404; font-weight: bold; font-size: 12px;">
          ‚ö†Ô∏è Configure Supabase Project ID and Anon Key in the script section below
        </div>
        <div class="form-group">
          <label>User Email</label>
          <input type="email" id="new-user-email" placeholder="user@example.com" style="font-size: 16px; padding: 10px; border: 2px solid #333;">
        </div>
        <div class="form-group">
          <label>User Password</label>
          <input type="password" id="new-user-password" placeholder="Enter password (min 6 chars)" style="font-size: 16px; padding: 10px; border: 2px solid #333;">
        </div>
        <div class="form-group">
          <label>User Role</label>
          <select id="new-user-role" style="font-size: 16px; padding: 10px; border: 2px solid #333; width: 100%;">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="controls">
          <button onclick="addNewUser()" style="background: #27ae60;">+ Add User</button>
          <button id="sync-users-btn" onclick="syncSupabaseUsers()" style="background: #3498db;">üîÑ Sync Users</button>
        </div>
      </div>

      <div class="form-section">
        <h2>Registered Users</h2>
        <table id="users-table">
          <thead>
            <tr><th>Email</th><th>Role</th><th>Created</th><th>Action</th></tr>
          </thead>
          <tbody id="users-body"></tbody>
        </table>
        <div id="no-users-message" style="padding: 15px; text-align: center; color: #666; font-weight: bold;">
          No users yet. Add a user above.
        </div>
      </div>
      
      <div class="form-section">
        <h2>System Statistics</h2>
        <table>
          <tr><td><strong>Total Users</strong></td><td id="total-users">1</td></tr>
          <tr><td><strong>Total Invoices</strong></td><td id="admin-total-invoices">0</td></tr>
          <tr><td><strong>Total Revenue</strong></td><td id="admin-total-revenue">0.00</td></tr>
          <tr><td><strong>Avg Per Invoice</strong></td><td id="admin-avg-invoice">0.00</td></tr>
        </table>
      </div>

      <div class="form-section">
        <h2>Search User Data</h2>
        <div class="form-group">
          <label>Search by Customer Name</label>
          <input type="text" id="search-user-input" placeholder="Enter customer name..." style="font-size: 16px; padding: 10px; border: 2px solid #333;" oninput="searchUserData()" />
        </div>
        <table id="search-results-table" style="margin-top: 15px; display: none;">
          <thead>
            <tr><th>Date</th><th>Customer</th><th>Address</th><th>Amount</th><th>Method</th></tr>
          </thead>
          <tbody id="search-results-body"></tbody>
        </table>
        <div id="no-results-message" style="display: none; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 4px; color: #856404; font-weight: bold; text-align: center;">
          No results found for your search.
        </div>
      </div>

      <div class="form-section">
        <h2>Export Data</h2>
        <div class="controls">
          <button onclick="exportToCSV()" style="background: #27ae60;">Export CSV</button>
          <button onclick="exportToPDF()" style="background: #e74c3c;">Export PDF</button>
          <button onclick="resetData()" style="background: #e74c3c;">Reset Data</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Invoice Print Modal -->
<div id="print-modal" class="modal">
  <div class="modal-content" style="position: relative;">
    <button class="modal-close" onclick="closePrintModal()">√ó</button>
    <div id="invoice-preview" class="invoice-preview" style="width: 50mm; margin: 0 auto; font-size: 8px; line-height: 1.1;"></div>
    <div class="controls" style="margin-top: 15px; text-align: center;">
      <button onclick="printInvoice()" style="background: #27ae60;">Print</button>
      <button onclick="downloadInvoicePDF()" style="background: #3498db;">Download PDF</button>
      <button onclick="closePrintModal()" style="background: #95a5a6;">Close</button>
    </div>
  </div>
</div>

<script>
// ============================================
// SUPABASE CONFIGURATION
// ============================================
// Replace these with your actual Supabase credentials
const SUPABASE_URL = 'https://qaqozmyitxvitekolgcd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhcW96bXlpdHh2aXRla29sZ2NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTYwODUsImV4cCI6MjA4Mzk3MjA4NX0.Ae72w1IrwmseG1MHehBBZffmb8P0dz-Q10KSzqIHglo';

// Initialize Supabase
var supabase = null;
var supabaseUsers = [];

function initSupabase() {
  if (SUPABASE_URL === 'https://YOUR_PROJECT_ID.supabase.co') {
    console.warn('‚ö†Ô∏è Supabase not configured. Using local storage only.');
    return;
  }
  
  // Check if Supabase SDK is loaded
  if (!window.supabase || !window.supabase.createClient) {
    console.warn('‚ö†Ô∏è Supabase SDK not loaded. Using local storage only.');
    syncSupabaseUsers();
    return;
  }
  
  const { createClient } = window.supabase;
  supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  syncSupabaseUsers();
}

// ============================================
// GLOBAL STATE
// ============================================
var currentUser = null;
var currentRole = 'user';
var items = [];
var invoices = [];
var shopName = 'Your Shop';

const STORAGE_KEY = 'billing_system_v1';
const USERS_KEY = 'billing_users_v1';
const SHOP_NAME_KEY = 'shop_name_v1';
const SESSION_KEY = 'billing_session_v1';

// Initialize when document is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
  });
} else {
  initializeApp();
}

function initializeApp() {
  const dateInput = document.getElementById('invoice-date');
  if (dateInput) {
    dateInput.valueAsDate = new Date();
  }
  initSupabase();
  
  // Check for existing session
  checkExistingSession();
}

// Check if user has an existing session
async function checkExistingSession() {
  const session = localStorage.getItem(SESSION_KEY);
  if (session) {
    try {
      const { email, role } = JSON.parse(session);
      currentUser = email;
      currentRole = role;
      
      // Hide login screen and show app
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('header').style.display = 'flex';
      document.getElementById('main-container').style.display = 'flex';
      document.getElementById('current-user').textContent = email + ' (' + role.toUpperCase() + ')';
      
      // Load user data from Supabase
      await loadData();
      await loadProducts();
      
      if (role === 'admin') {
        document.getElementById('admin-btn').style.display = 'block';
        updateUsersTable();
      } else {
        document.getElementById('admin-btn').style.display = 'none';
      }
      
      console.log('Session restored: ' + email);
    } catch (error) {
      console.error('Error restoring session:', error);
      // Clear invalid session
      localStorage.removeItem(SESSION_KEY);
    }
  }
}

// Load data from Supabase
async function loadData() {
  if (!supabase || !currentUser) {
    // Fallback to localStorage if Supabase not available
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      invoices = JSON.parse(saved);
      updateDashboard();
    }
    return;
  }

  try {
    // Load invoices from Supabase
    const { data: invoicesData, error: invoicesError } = await supabase
      .from('invoices')
      .select('*')
      .eq('user_email', currentUser)
      .order('created_at', { ascending: false });

    if (!invoicesError && invoicesData) {
      invoices = invoicesData.map(inv => ({
        id: inv.id,
        date: inv.invoice_date,
        customer: inv.customer_name,
        address: inv.customer_address,
        method: inv.payment_method,
        total: inv.total_amount,
        items: inv.items || [],
        user: inv.user_email,
        savedDate: inv.created_at
      }));
    }
    
    // Load shop settings from Supabase
    const { data: settingsData, error: settingsError } = await supabase
      .from('shop_settings')
      .select('shop_name')
      .eq('user_email', currentUser)
      .single();

    if (!settingsError && settingsData) {
      shopName = settingsData.shop_name;
    } else {
      shopName = 'Your Shop';
    }

    const shopNameInput = document.getElementById('shop-name-input');
    if (shopNameInput) shopNameInput.value = shopName;
    const currentShopName = document.getElementById('current-shop-name');
    if (currentShopName) currentShopName.textContent = shopName;
    const billShopName = document.getElementById('bill-shop-name');
    if (billShopName) billShopName.textContent = shopName;
    
    updateDashboard();
    
  } catch (error) {
    console.error('Error loading data from Supabase:', error);
    // Fallback to localStorage
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      invoices = JSON.parse(saved);
      updateDashboard();
    }
  }
}

// Authentication
async function login() {
  const email = document.getElementById('username-input').value.trim();
  const password = document.getElementById('password-input').value.trim();
  const role = document.getElementById('role-select').value;

  if (!email || !password) {
    alert('Please enter credentials');
    return;
  }

  // Check if Supabase is configured
  if (supabase) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (error) {
        alert('Login failed: ' + error.message);
        return;
      }

      // Get user role from local users list
      const user = supabaseUsers.find(u => u.email.toLowerCase() === email.toLowerCase());
      const userRole = user ? user.role : 'user';

      currentUser = email;
      currentRole = userRole;
      
      // Save session to localStorage
      localStorage.setItem(SESSION_KEY, JSON.stringify({ email: email, role: userRole }));
      
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('header').style.display = 'flex';
      document.getElementById('main-container').style.display = 'flex';
      document.getElementById('current-user').textContent = email + ' (' + userRole.toUpperCase() + ')';
      
      if (userRole === 'admin') {
        document.getElementById('admin-btn').style.display = 'block';
        updateUsersTable();
      } else {
        document.getElementById('admin-btn').style.display = 'none';
      }
      
      // Load user data from Supabase
      await loadData();
      await loadProducts();
    } catch (error) {
      alert('Login error: ' + error.message);
    }
  } else {
    // Fallback to local storage authentication
    authenticateLocally(email, password, role);
  }
}

function authenticateLocally(email, password, role) {
  const user = supabaseUsers.find(u => u.email.toLowerCase() === email.toLowerCase());
  
  if (!user) {
    alert('User not found!');
    return;
  }

  if (user.password !== password) {
    alert('Invalid password!');
    return;
  }

  if (role === 'admin' && user.role !== 'admin') {
    alert('This account is not an admin account!');
    return;
  }

  if (role === 'user' && user.role === 'admin') {
    alert('Admin accounts must login as Admin!');
    return;
  }

  currentUser = email;
  currentRole = user.role;
  
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('header').style.display = 'flex';
  document.getElementById('main-container').style.display = 'flex';
  document.getElementById('current-user').textContent = email + ' (' + user.role.toUpperCase() + ')';
  
  if (user.role === 'admin') {
    document.getElementById('admin-btn').style.display = 'block';
    updateUsersTable();
  } else {
    document.getElementById('admin-btn').style.display = 'none';
  }
  
  loadData();
}

// Sync Supabase Users
async function syncSupabaseUsers() {
  if (!supabase) {
    // Load from local storage if Supabase not available
    const saved = localStorage.getItem(USERS_KEY);
    if (saved) {
      supabaseUsers = JSON.parse(saved);
    } else {
      // Initialize with default admin
      supabaseUsers = [
        { email: 'diwashb32@gmail.com', password: 'dipak@121', role: 'admin', created: new Date().toISOString() }
      ];
      localStorage.setItem(USERS_KEY, JSON.stringify(supabaseUsers));
    }
    return;
  }

  try {
    const { data: { users }, error } = await supabase.auth.admin.listUsers();
    
    if (error) {
      console.error('Error fetching users:', error);
      return;
    }

    // Map Supabase users to our format
    supabaseUsers = users.map(u => ({
      email: u.email,
      role: u.user_metadata?.role || 'user',
      created: u.created_at
    }));

    localStorage.setItem(USERS_KEY, JSON.stringify(supabaseUsers));
  } catch (error) {
    console.error('Sync error:', error);
  }
}

// Add New User (Admin Only)
async function addNewUser() {
  // Check if user is admin
  if (currentRole !== 'admin') {
    alert('‚ùå Only admins can add new users!');
    return;
  }

  const email = document.getElementById('new-user-email').value.trim();
  const password = document.getElementById('new-user-password').value.trim();
  const role = document.getElementById('new-user-role').value;

  if (!email || !password) {
    alert('Please fill in email and password');
    return;
  }

  if (password.length < 6) {
    alert('Password must be at least 6 characters');
    return;
  }

  if (!email.includes('@')) {
    alert('Please enter a valid email');
    return;
  }

  // Check if user already exists
  if (supabaseUsers.find(u => u.email.toLowerCase() === email.toLowerCase())) {
    alert('User already exists!');
    return;
  }

  if (supabase) {
    try {
      document.getElementById('sync-users-btn').disabled = true;
      const { data, error } = await supabase.auth.admin.createUser({
        email: email,
        password: password,
        user_metadata: { role: role }
      });

      if (error) {
        alert('Error creating user: ' + error.message);
        document.getElementById('sync-users-btn').disabled = false;
        return;
      }

      // Add to local list
      supabaseUsers.push({
        email: email,
        password: password,
        role: role,
        created: new Date().toISOString()
      });

      localStorage.setItem(USERS_KEY, JSON.stringify(supabaseUsers));
      alert('‚úÖ User created successfully in Supabase!');
      document.getElementById('sync-users-btn').disabled = false;
    } catch (error) {
      alert('Error: ' + error.message);
      document.getElementById('sync-users-btn').disabled = false;
    }
  } else {
    // Local storage only
    supabaseUsers.push({
      email: email,
      password: password,
      role: role,
      created: new Date().toISOString()
    });
    localStorage.setItem(USERS_KEY, JSON.stringify(supabaseUsers));
    alert('‚úÖ User created successfully!');
  }

  // Clear form
  document.getElementById('new-user-email').value = '';
  document.getElementById('new-user-password').value = '';
  document.getElementById('new-user-role').value = 'user';
  updateUsersTable();
}

// Delete User (Admin Only)
async function deleteUser(email) {
  // Check if user is admin
  if (currentRole !== 'admin') {
    alert('‚ùå Only admins can delete users!');
    return;
  }

  if (!confirm(`Delete user ${email}?`)) return;

  if (supabase) {
    try {
      const { data: { users }, error: listError } = await supabase.auth.admin.listUsers();
      const user = users.find(u => u.email === email);

      if (user) {
        const { error } = await supabase.auth.admin.deleteUser(user.id);
        if (error) {
          alert('Error deleting user: ' + error.message);
          return;
        }
      }
    } catch (error) {
      alert('Error: ' + error.message);
      return;
    }
  }

  supabaseUsers = supabaseUsers.filter(u => u.email !== email);
  localStorage.setItem(USERS_KEY, JSON.stringify(supabaseUsers));
  alert('User deleted!');
  updateUsersTable();
}

// Update Users Table
function updateUsersTable() {
  const usersBody = document.getElementById('users-body');
  const noUsersMsg = document.getElementById('no-users-message');

  if (supabaseUsers.length === 0) {
    usersBody.innerHTML = '';
    noUsersMsg.style.display = 'block';
    document.getElementById('total-users').textContent = 0;
    return;
  }

  noUsersMsg.style.display = 'none';
  let html = '';
  supabaseUsers.forEach(user => {
    const created = new Date(user.created).toLocaleDateString();
    html += `<tr>
      <td>${user.email}</td>
      <td><span style="background: ${user.role === 'admin' ? '#e74c3c' : '#27ae60'}; color: white; padding: 4px 8px; border-radius: 3px;">${user.role.toUpperCase()}</span></td>
      <td>${created}</td>
      <td><button class="delete-btn" onclick="deleteUser('${user.email}')">Delete</button></td>
    </tr>`;
  });
  usersBody.innerHTML = html;
  document.getElementById('total-users').textContent = supabaseUsers.length;
}

function logout() {
  currentUser = null;
  currentRole = 'user';
  items = [];
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('header').style.display = 'none';
  document.getElementById('main-container').style.display = 'none';
  document.getElementById('username-input').value = '';
  document.getElementById('password-input').value = '';
}

// Save Shop Name (Admin Only)
async function saveShopName() {
  const shopNameInput = document.getElementById('shop-name-input').value.trim();
  
  if (!shopNameInput) {
    alert('Please enter a shop name');
    return;
  }
  
  shopName = shopNameInput;
  
  // Save to Supabase
  if (supabase && currentUser) {
    try {
      // Try to update first
      const { data: existing } = await supabase
        .from('shop_settings')
        .select('id')
        .eq('user_email', currentUser)
        .single();

      if (existing) {
        // Update existing
        const { error } = await supabase
          .from('shop_settings')
          .update({ shop_name: shopName })
          .eq('user_email', currentUser);
        if (error) throw error;
      } else {
        // Insert new
        const { error } = await supabase
          .from('shop_settings')
          .insert([{ user_email: currentUser, shop_name: shopName }]);
        if (error) throw error;
      }
      console.log('Shop name saved to Supabase');
    } catch (error) {
      console.error('Error saving shop name to Supabase:', error);
      // Still save to localStorage as backup
      localStorage.setItem(SHOP_NAME_KEY, shopName);
    }
  } else {
    localStorage.setItem(SHOP_NAME_KEY, shopName);
  }
  
  document.getElementById('current-shop-name').textContent = shopName;
  document.getElementById('bill-shop-name').textContent = shopName;
  alert('Shop name saved: ' + shopName);
}

// Navigation
function setupNavigation() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      const sectionId = this.dataset.section + '-section';
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
      }
      
      // Close sidebar on mobile after navigation
      closeSidebar();
    });
  });
}

// Setup navigation when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupNavigation);
} else {
  setupNavigation();
}

// Mobile Sidebar Toggle
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('show');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('show');
  overlay.classList.remove('show');
}

// Items Management
function addItem() {
  const itemsBody = document.getElementById('items-body');
  const rowCount = itemsBody.querySelectorAll('tr').length + 1;
  
  const row = document.createElement('tr');
  let productOptions = '<option value="">Select product...</option>';
  products.forEach(p => {
    const disabled = p.stock === 0 ? 'disabled' : '';
    productOptions += `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" data-category="${p.category || 'Uncategorized'}" ${disabled}>
      ${p.name} (Stock: ${p.stock}) - ${p.category || 'Uncategorized'}
    </option>`;
  });
  productOptions += '<option value="other" data-price="0" data-stock="unlimited">‚ûï Other (Custom Product)</option>';

  row.innerHTML = `
    <td style="font-weight: bold; font-size: 15px;">${rowCount}</td>
    <td>
      <select class="product-select" onchange="updateItemPrice(this)" style="width: 100%; padding: 6px; border: 2px solid #333; font-weight: bold; font-size: 14px;">
        ${productOptions}
      </select>
      <input type="text" class="custom-product-name" placeholder="Enter product name" style="display: none; width: 100%; padding: 6px; border: 2px solid #333; font-weight: bold; font-size: 14px; margin-top: 4px;" />
    </td>
    <td style="font-size: 13px; color: #666;" class="product-category">-</td>
    <td><input type="number" class="qty" value="1" min="1" style="width: 50px; padding: 6px; border: 2px solid #333; font-weight: bold; font-size: 14px;" onchange="calcTotal()"></td>
    <td><input type="number" class="price" value="0" min="0" step="0.01" style="width: 70px; padding: 6px; border: 2px solid #333; font-weight: bold; font-size: 14px;" onchange="calcTotal()"></td>
    <td style="font-weight: bold; font-size: 15px;"><span class="item-total">0.00</span></td>
    <td><button class="delete-btn" onclick="deleteItem(this); recalculateItemNumbers();">Delete</button></td>
  `;
  itemsBody.appendChild(row);
  items.push({});
  updateCategoryFilter();
  calcTotal();
}

function updateItemPrice(selectElement) {
  const row = selectElement.closest('tr');
  const priceInput = row.querySelector('.price');
  const categoryCell = row.querySelector('.product-category');
  const customNameInput = row.querySelector('.custom-product-name');
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  
  if (selectedOption.value === 'other') {
    priceInput.value = 0;
    priceInput.readOnly = false;
    customNameInput.style.display = 'block';
    categoryCell.textContent = 'Custom';
  } else if (selectedOption.value) {
    const price = selectedOption.getAttribute('data-price');
    const category = selectedOption.getAttribute('data-category');
    priceInput.value = price;
    priceInput.readOnly = true;
    customNameInput.style.display = 'none';
    categoryCell.textContent = category;
  } else {
    priceInput.value = 0;
    priceInput.readOnly = true;
    customNameInput.style.display = 'none';
    categoryCell.textContent = '-';
  }
  calcTotal();
}

function updateCategoryFilter() {
  const categoryFilter = document.getElementById('item-category-filter');
  const categories = new Set();
  categories.add('Other');
  products.forEach(p => {
    if (p.category) categories.add(p.category);
  });
  
  const selectedValue = categoryFilter.value;
  categoryFilter.innerHTML = '<option value="">All Categories</option>';
  Array.from(categories).sort().forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    categoryFilter.appendChild(option);
  });
  categoryFilter.value = selectedValue;
}

function filterItemsByCategory() {
  const categoryFilter = document.getElementById('item-category-filter').value;
  const productSelects = document.querySelectorAll('.product-select');
  
  productSelects.forEach(select => {
    const options = select.querySelectorAll('option');
    options.forEach(option => {
      if (!categoryFilter) {
        option.style.display = '';
      } else {
        const category = option.getAttribute('data-category');
        const isOther = option.value === 'other';
        const isAllowedCategory = category === categoryFilter || (categoryFilter === 'Other' && isOther);
        option.style.display = isAllowedCategory ? '' : 'none';
      }
    });
  });
}

function filterItemsBySearch() {
  const searchTerm = document.getElementById('item-search').value.toLowerCase();
  const productSelects = document.querySelectorAll('.product-select');
  
  productSelects.forEach(select => {
    const options = select.querySelectorAll('option');
    options.forEach(option => {
      if (!searchTerm) {
        option.style.display = '';
      } else {
        const text = option.text.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      }
    });
  });
}

function deleteItem(button) {
  button.closest('tr').remove();
  recalculateItemNumbers();
  calcTotal();
}

function recalculateItemNumbers() {
  const rows = document.querySelectorAll('#items-body tr');
  rows.forEach((row, index) => {
    row.querySelector('td:first-child').textContent = index + 1;
  });
}

function calcTotal() {
  let subtotal = 0;
  const rows = document.querySelectorAll('#items-body tr');
  
  rows.forEach(row => {
    const qtyInput = row.querySelector('.qty');
    const priceInput = row.querySelector('.price');
    const totalSpan = row.querySelector('.item-total');
    
    const qty = parseFloat(qtyInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = qty * price;
    
    if (totalSpan) {
      totalSpan.textContent = total.toFixed(2);
    }
    subtotal += total;
  });

  const finalTotalElement = document.getElementById('final-total');
  if (finalTotalElement) {
    finalTotalElement.textContent = subtotal.toFixed(2);
  }
  
  calcPaidUnpaid();
}

function calcPaidUnpaid() {
  const totalAmount = parseFloat(document.getElementById('final-total').textContent) || 0;
  const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
  const unpaidAmount = Math.max(0, totalAmount - paidAmount);
  
  document.getElementById('unpaid-amount').value = unpaidAmount.toFixed(2);
  
  const statusDiv = document.getElementById('payment-status');
  if (unpaidAmount === 0) {
    statusDiv.textContent = '‚úÖ PAID IN FULL';
    statusDiv.style.color = '#27ae60';
  } else if (paidAmount === 0) {
    statusDiv.textContent = '‚è≥ NOT PAID';
    statusDiv.style.color = '#e74c3c';
  } else {
    statusDiv.textContent = '‚ö†Ô∏è PARTIAL PAYMENT';
    statusDiv.style.color = '#f39c12';
  }
}

// Invoice Generation
function generateInvoice() {
  const custName = document.getElementById('cust-name').value || 'Customer';
  const custAddr = document.getElementById('cust-addr').value || 'N/A';
  const date = document.getElementById('invoice-date').value;
  const method = document.getElementById('payment-method').value;
  const total = parseFloat(document.getElementById('final-total').textContent);

  let itemsHtml = '';
  document.querySelectorAll('#items-body tr').forEach((row, idx) => {
    const select = row.querySelector('.product-select');
    const qty = row.querySelector('.qty').value || '0';
    const price = row.querySelector('.price').value || '0';
    const itemTotal = row.querySelector('.item-total').textContent || '0';
    const customName = row.querySelector('.custom-product-name');
    
    // Get product name from dropdown or custom input
    let productName = 'Unknown';
    if (select.value === 'other') {
      productName = customName.value || 'Custom Product';
    } else {
      const selectedOption = select.options[select.selectedIndex];
      productName = selectedOption ? selectedOption.text : 'Unknown';
    }
    
    itemsHtml += `<tr><td>${idx+1}</td><td>${productName}</td><td>${qty}</td><td>${price}</td><td>${itemTotal}</td></tr>`;
  });

  const preview = `
    <div style="width: 65mm; padding: 8px; font-family: Arial; font-size: 14px; line-height: 1.6; border: 2px solid #000;">
      <div style="text-align: center; font-weight: bold; margin-bottom: 4px; font-size: 18px;">${shopName}</div>
      <div style="text-align: center; font-weight: bold; margin-bottom: 4px; font-size: 16px;">INVOICE</div>
      <div style="font-size: 13px; font-weight: bold; margin-bottom: 2px;">Date: ${date}</div>
      <div style="font-size: 13px; font-weight: bold; margin-bottom: 2px;">Customer: ${custName}</div>
      <div style="font-size: 13px; font-weight: bold; margin-bottom: 4px;">${custAddr}</div>
      <hr style="margin: 4px 0; border: none; border-top: 2px solid #000;">
      <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 4px;">
        <tr style="border-bottom: 2px solid #000;"><th style="padding: 4px; text-align: center; font-weight: bold;">#</th><th style="padding: 4px; font-weight: bold;">Product</th><th style="padding: 4px; text-align: center; font-weight: bold;">Qty</th><th style="padding: 4px; text-align: right; font-weight: bold;">Price</th><th style="padding: 4px; text-align: right; font-weight: bold;">Total</th></tr>
        ${itemsHtml}
      </table>
      <hr style="margin: 4px 0; border: none; border-top: 2px solid #000;">
      <div style="text-align: right; font-weight: bold; font-size: 15px; margin: 4px 0;">Total: ${total.toFixed(2)}</div>
      <div style="font-size: 12px; font-weight: bold; margin-top: 4px;">Method: ${method}</div>
      <hr style="margin: 4px 0; border: none; border-top: 2px solid #000;">
      <div style="font-size: 12px; font-weight: bold; text-align: center;">Thank You!</div>
    </div>
  `;

  document.getElementById('invoice-preview').innerHTML = preview;
  document.getElementById('print-modal').classList.add('show');
}

function printInvoice() {
  // Auto-save invoice before printing
  saveInvoice();
  
  const preview = document.getElementById('invoice-preview').innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><style>body{width:50mm;margin:0;padding:5px;font-family:Arial;}</style></head><body>${preview}</body></html>`);
  w.document.close();
  w.print();
}

async function downloadInvoicePDF() {
  // Auto-save invoice before downloading
  saveInvoice();
  
  const element = document.getElementById('invoice-preview');
  const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#fff' });
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'mm', format: [50, 70] });
  const imgData = canvas.toDataURL('image/png');
  pdf.addImage(imgData, 'PNG', 0, 0, 50, 70);
  pdf.save(`invoice_${new Date().getTime()}.pdf`);
}

function closePrintModal() {
  document.getElementById('print-modal').classList.remove('show');
}

// Save Invoice
async function saveInvoice() {
  const custName = document.getElementById('cust-name').value;
  const custAddr = document.getElementById('cust-addr').value;
  const date = document.getElementById('invoice-date').value;
  const method = document.getElementById('payment-method').value;
  const total = parseFloat(document.getElementById('final-total').textContent);
  const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
  const unpaidAmount = parseFloat(document.getElementById('unpaid-amount').value) || 0;

  if (!custName || !date || total === 0) {
    alert('Please fill all details and add items');
    return false;
  }

  // Reduce stock for each item
  const invoiceItems = [];
  const rows = Array.from(document.querySelectorAll('#items-body tr'));
  
  for (const tr of rows) {
    const select = tr.querySelector('.product-select');
    const productId = select.value;
    const qty = parseInt(tr.querySelector('.qty').value);
    const price = tr.querySelector('.price').value;
    const customName = tr.querySelector('.custom-product-name');
    
    let productName = 'Unknown';
    if (productId === 'other') {
      productName = customName.value || 'Custom Product';
    } else {
      const selectedOption = select.options[select.selectedIndex];
      productName = selectedOption ? selectedOption.text : 'Unknown';
    }
    
    // Reduce stock only for actual products
    if (productId && productId !== 'other') {
      if (!await reduceStock(parseInt(productId), qty)) {
        alert('Cannot complete sale - insufficient stock');
        return null;
      }
    }
    
    invoiceItems.push({
      productId: productId,
      productName: productName,
      qty: qty,
      price: price
    });
  }

  if (invoiceItems.length === 0) {
    alert('No valid items in invoice');
    return false;
  }

  const invoice = {
    id: Date.now(),
    date,
    customer: custName,
    address: custAddr,
    method,
    total,
    paidAmount,
    unpaidAmount,
    items: invoiceItems,
    user: currentUser,
    savedDate: new Date().toISOString()
  };

  invoices.push(invoice);
  
  // Save invoice to Supabase
  if (supabase && currentUser) {
    try {
      const { error } = await supabase.from('invoices').insert([
        {
          invoice_date: date,
          customer_name: custName,
          customer_address: custAddr,
          payment_method: method,
          total_amount: total,
          paid_amount: paidAmount,
          unpaid_amount: unpaidAmount,
          items: invoiceItems,
          user_email: currentUser,
          created_at: new Date().toISOString()
        }
      ]);
      if (error) throw error;
      console.log('Invoice saved to Supabase! Total: ' + total.toFixed(2));
    } catch (error) {
      console.error('Error saving invoice to Supabase:', error);
      // Still save to localStorage as backup
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
    }
  } else {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
  }
  
  console.log('Invoice saved! Total: ' + total.toFixed(2));
  clearForm();
  updateDashboard();
  return true;
}

function clearForm() {
  const custName = document.getElementById('cust-name');
  const custAddr = document.getElementById('cust-addr');
  const itemsBody = document.getElementById('items-body');
  const invoiceDate = document.getElementById('invoice-date');
  const paidAmount = document.getElementById('paid-amount');
  const itemSearch = document.getElementById('item-search');
  const categoryFilter = document.getElementById('item-category-filter');
  
  if (custName) custName.value = '';
  if (custAddr) custAddr.value = '';
  if (itemsBody) itemsBody.innerHTML = '';
  items = [];
  if (itemsBody) addItem();
  if (paidAmount) paidAmount.value = '';
  if (itemSearch) itemSearch.value = '';
  if (categoryFilter) categoryFilter.value = '';
  calcTotal();
  if (invoiceDate) invoiceDate.valueAsDate = new Date();
}

// Dashboard
function updateDashboard() {
  const total = getTotalRevenue();
  const count = invoices.length;
  const avg = count > 0 ? total / count : 0;
  const thisMonth = getMonthRevenue();

  const safeSetText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  safeSetText('total-revenue', total.toFixed(2));
  safeSetText('total-invoices', count);
  safeSetText('month-revenue', thisMonth.toFixed(2));
  safeSetText('avg-invoice', avg.toFixed(2));
  safeSetText('admin-total-invoices', count);
  safeSetText('admin-total-revenue', total.toFixed(2));
  safeSetText('admin-avg-invoice', avg.toFixed(2));

  // Recent transactions
  const recent = invoices.slice(-5).reverse();
  let html = '';
  recent.forEach(inv => {
    html += `<tr><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.total.toFixed(2)}</td><td>${inv.method}</td></tr>`;
  });
  const recentBody = document.getElementById('recent-body');
  if (recentBody) recentBody.innerHTML = html;

  // Invoice history
  html = '';
  invoices.forEach(inv => {
    html += `<tr><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.total.toFixed(2)}</td><td>${inv.method}</td><td><button class="delete-btn" onclick="deleteInvoice(${inv.id})">Delete</button></td></tr>`;
  });
  const invoicesBody = document.getElementById('invoices-body');
  if (invoicesBody) invoicesBody.innerHTML = html;
}

function getTotalRevenue() {
  return invoices.reduce((sum, inv) => sum + inv.total, 0);
}

function getMonthRevenue() {
  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();
  return invoices.filter(inv => {
    const invDate = new Date(inv.date);
    return invDate.getMonth() === month && invDate.getFullYear() === year;
  }).reduce((sum, inv) => sum + inv.total, 0);
}

async function deleteInvoice(id) {
  if (confirm('Delete this invoice?')) {
    invoices = invoices.filter(inv => inv.id !== id);
    
    // Delete from Supabase
    if (supabase && currentUser) {
      try {
        const { error } = await supabase.from('invoices').delete().eq('id', id);
        if (error) throw error;
        console.log('Invoice deleted from Supabase');
      } catch (error) {
        console.error('Error deleting invoice from Supabase:', error);
        // Still update localStorage as backup
        localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      }
    } else {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
    }
    
    updateDashboard();
  }
}

// Search User Data (Admin Only)
function searchUserData() {
  const searchInput = document.getElementById('search-user-input').value.toLowerCase().trim();
  const searchResultsTable = document.getElementById('search-results-table');
  const searchResultsBody = document.getElementById('search-results-body');
  const noResultsMessage = document.getElementById('no-results-message');

  if (!searchInput) {
    searchResultsTable.style.display = 'none';
    noResultsMessage.style.display = 'none';
    return;
  }

  // Filter invoices by customer name
  const results = invoices.filter(inv => 
    inv.customer.toLowerCase().includes(searchInput)
  );

  if (results.length === 0) {
    searchResultsTable.style.display = 'none';
    noResultsMessage.style.display = 'block';
    return;
  }

  // Display results
  let html = '';
  results.forEach(inv => {
    html += `<tr><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.address}</td><td>${inv.total.toFixed(2)}</td><td>${inv.method}</td></tr>`;
  });

  searchResultsBody.innerHTML = html;
  searchResultsTable.style.display = 'table';
  noResultsMessage.style.display = 'none';
}

// Export Functions
function exportToCSV() {
  let csv = 'Date,Customer,Address,Total,Method\n';
  invoices.forEach(inv => {
    csv += `${inv.date},"${inv.customer}","${inv.address}",${inv.total},${inv.method}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `invoices_${new Date().getTime()}.csv`;
  a.click();
}

async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;
  
  pdf.setFontSize(16);
  pdf.text('Invoice Report', 10, y);
  y += 15;
  
  pdf.setFontSize(10);
  pdf.text(`Total Revenue: ${getTotalRevenue().toFixed(2)}`, 10, y);
  y += 10;
  pdf.text(`Total Invoices: ${invoices.length}`, 10, y);
  y += 15;
  
  pdf.setFontSize(9);
  pdf.text('Date | Customer | Amount | Method', 10, y);
  y += 8;
  
  invoices.forEach(inv => {
    pdf.text(`${inv.date} | ${inv.customer} | ${inv.total.toFixed(2)} | ${inv.method}`, 10, y);
    y += 7;
    if (y > 270) {
      pdf.addPage();
      y = 10;
    }
  });
  
  pdf.save(`report_${new Date().getTime()}.pdf`);
}

function resetData() {
  if (confirm('This will delete ALL data. Are you sure?')) {
    localStorage.removeItem(STORAGE_KEY);
    invoices = [];
    updateDashboard();
    alert('Data cleared!');
  }
}

// ============================================
// PRODUCTS MANAGEMENT
// ============================================
var products = [];
const PRODUCTS_KEY = 'billing_products_v1';

// Load products from Supabase
async function loadProducts() {
  if (!supabase || !currentUser) {
    // Fallback to localStorage
    const saved = localStorage.getItem(PRODUCTS_KEY);
    if (saved) {
      products = JSON.parse(saved);
      updateProductsTable();
      updateLowStockAlert();
      updateBillingProductSelect();
    }
    return;
  }

  try {
    const { data: productsData, error } = await supabase
      .from('products')
      .select('*')
      .eq('user_email', currentUser)
      .order('created_at', { ascending: false });

    if (!error && productsData) {
      products = productsData.map(p => ({
        id: p.id,
        code: p.product_code,
        name: p.product_name,
        description: p.description,
        price: p.price,
        stock: p.stock_quantity,
        category: p.category,
        user: p.user_email,
        savedDate: p.created_at
      }));
      updateProductsTable();
      updateLowStockAlert();
      updateBillingProductSelect();
    } else {
      console.warn('Error loading products:', error);
      // Fallback to localStorage
      const saved = localStorage.getItem(PRODUCTS_KEY);
      if (saved) {
        products = JSON.parse(saved);
      }
    }
  } catch (error) {
    console.error('Error loading products from Supabase:', error);
    // Fallback to localStorage
    const saved = localStorage.getItem(PRODUCTS_KEY);
    if (saved) {
      products = JSON.parse(saved);
    }
  }
}

// Add new product
async function addProduct() {
  const name = document.getElementById('product-name').value.trim();
  const code = document.getElementById('product-code').value.trim();
  const desc = document.getElementById('product-desc').value.trim();
  const price = parseFloat(document.getElementById('product-price').value);
  const stock = parseInt(document.getElementById('product-stock').value);
  const category = document.getElementById('product-category').value.trim();

  if (!name || !code || !price || stock < 0) {
    alert('Please fill all required fields');
    return;
  }

  // Check if product code already exists
  if (products.find(p => p.code.toLowerCase() === code.toLowerCase())) {
    alert('Product code already exists!');
    return;
  }

  const product = {
    id: Date.now(),
    code: code,
    name: name,
    description: desc,
    price: price,
    stock: stock,
    category: category,
    user: currentUser,
    created: new Date().toISOString()
  };

  products.push(product);
  
  // Save to Supabase first
  if (supabase && currentUser) {
    try {
      const { error } = await supabase.from('products').insert([
        {
          user_email: currentUser,
          product_code: code,
          product_name: name,
          description: desc,
          price: price,
          stock_quantity: stock,
          category: category,
          created_at: new Date().toISOString()
        }
      ]);
      if (error) throw error;
      console.log('Product saved to Supabase');
    } catch (error) {
      console.error('Error saving product to Supabase:', error);
      // Still save to localStorage as backup
      localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
    }
  } else {
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
  }
  
  alert('‚úÖ Product added successfully!');
  clearProductForm();
  updateProductsTable();
  updateLowStockAlert();
  updateBillingProductSelect();
}

// Delete product
async function deleteProduct(productId) {
  if (!confirm('Delete this product?')) return;
  
  products = products.filter(p => p.id !== productId);
  
  // Delete from Supabase
  if (supabase && currentUser) {
    try {
      const { error } = await supabase.from('products').delete().eq('id', productId);
      if (error) throw error;
      console.log('Product deleted from Supabase');
    } catch (error) {
      console.error('Error deleting product from Supabase:', error);
      // Still save to localStorage as backup
      localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
    }
  } else {
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
  }
  
  updateProductsTable();
  updateLowStockAlert();
  updateBillingProductSelect();
}

// Update stock after sale
async function reduceStock(productId, quantitySold) {
  const product = products.find(p => p.id === productId);
  if (!product) return false;

  if (product.stock < quantitySold) {
    alert('‚ùå Insufficient stock for ' + product.name);
    return false;
  }

  product.stock -= quantitySold;
  
  // Update in Supabase
  if (supabase && currentUser) {
    try {
      const { error } = await supabase
        .from('products')
        .update({ stock_quantity: product.stock })
        .eq('id', productId);
      if (error) throw error;
      console.log('Stock updated in Supabase');
    } catch (error) {
      console.error('Error updating stock in Supabase:', error);
      // Still save to localStorage as backup
      localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
    }
  } else {
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
  }
  
  updateProductsTable();
  updateLowStockAlert();
  return true;
}

// Update products table
function updateProductsTable() {
  const productsBody = document.getElementById('products-body');
  const noProductsMsg = document.getElementById('no-products-message');

  if (products.length === 0) {
    productsBody.innerHTML = '';
    noProductsMsg.style.display = 'block';
    return;
  }

  noProductsMsg.style.display = 'none';
  let html = '';
  products.forEach(p => {
    const stockStatus = p.stock > 10 ? '‚úÖ' : p.stock > 0 ? '‚ö†Ô∏è' : '‚ùå';
    html += `<tr>
      <td><strong>${p.code}</strong></td>
      <td>${p.name}</td>
      <td>${p.price.toFixed(2)}</td>
      <td>${stockStatus} ${p.stock}</td>
      <td>${p.category || 'N/A'}</td>
      <td>
        <button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
      </td>
    </tr>`;
  });
  productsBody.innerHTML = html;
}

// Update low stock alert
function updateLowStockAlert() {
  const lowStockBody = document.getElementById('low-stock-body');
  const noLowStockMsg = document.getElementById('no-low-stock-message');

  const lowStockProducts = products.filter(p => p.stock <= 10);

  if (lowStockProducts.length === 0) {
    lowStockBody.innerHTML = '';
    noLowStockMsg.style.display = 'block';
    return;
  }

  noLowStockMsg.style.display = 'none';
  let html = '';
  lowStockProducts.forEach(p => {
    const needed = 20 - p.stock;
    html += `<tr style="background: #ffe0e0;">
      <td><strong>${p.name}</strong></td>
      <td style="color: #e74c3c; font-weight: bold;">${p.stock}</td>
      <td>20</td>
      <td style="color: #e74c3c; font-weight: bold;">+${needed}</td>
    </tr>`;
  });
  lowStockBody.innerHTML = html;
}

// Update product select in billing section
function updateBillingProductSelect() {
  const productSelects = document.querySelectorAll('.product-select');
  productSelects.forEach(select => {
    const currentValue = select.value;
    let html = '<option value="">Select product...</option>';
    products.forEach(p => {
      const disabled = p.stock === 0 ? 'disabled' : '';
      html += `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" data-category="${p.category || 'Uncategorized'}" ${disabled}>
        ${p.name} (Stock: ${p.stock}) - ${p.category || 'Uncategorized'}
      </option>`;
    });
    html += '<option value="other" data-price="0" data-stock="unlimited">‚ûï Other (Custom Product)</option>';
    select.innerHTML = html;
    select.value = currentValue;
  });
  updateCategoryFilter();
}

// Clear product form
function clearProductForm() {
  document.getElementById('product-name').value = '';
  document.getElementById('product-code').value = '';
  document.getElementById('product-desc').value = '';
  document.getElementById('product-price').value = '';
  document.getElementById('product-stock').value = '';
  document.getElementById('product-category').value = '';
}

// Update billing shop name from billing section
function updateBillingShopName() {
  const shopNameInput = document.getElementById('billing-shop-name').value.trim();
  if (!shopNameInput) {
    alert('Please enter a shop name');
    return;
  }
  
  shopName = shopNameInput;
  
  // Also update in admin settings
  document.getElementById('shop-name-input').value = shopName;
  
  // Save to Supabase
  if (supabase && currentUser) {
    try {
      supabase
        .from('shop_settings')
        .select('id')
        .eq('user_email', currentUser)
        .single()
        .then(({ data: existing }) => {
          if (existing) {
            supabase
              .from('shop_settings')
              .update({ shop_name: shopName })
              .eq('user_email', currentUser);
          } else {
            supabase
              .from('shop_settings')
              .insert([{ user_email: currentUser, shop_name: shopName }]);
          }
        });
    } catch (error) {
      console.error('Error:', error);
    }
  }
  
  localStorage.setItem(SHOP_NAME_KEY, shopName);
  document.getElementById('current-shop-name').textContent = shopName;
  document.getElementById('bill-shop-name').textContent = shopName;
  document.getElementById('billing-shop-name').value = '';
  alert('‚úÖ Shop name updated!');
}

// Initialize after DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    loadData();
    loadProducts();
    const itemsBody = document.getElementById('items-body');
    if (itemsBody && itemsBody.children.length === 0) {
      clearForm();
    }
    updateUsersTable();
    // Load billing shop name from current shop name
    const billingShopNameInput = document.getElementById('billing-shop-name');
    if (billingShopNameInput) {
      billingShopNameInput.placeholder = 'Current: ' + shopName;
    }
  });
} else {
  loadData();
  const itemsBody = document.getElementById('items-body');
  if (itemsBody && itemsBody.children.length === 0) {
    clearForm();
  }
  updateUsersTable();
  // Load billing shop name from current shop name
  const billingShopNameInput = document.getElementById('billing-shop-name');
  if (billingShopNameInput) {
    billingShopNameInput.placeholder = 'Current: ' + shopName;
  }
}
</script>

</body>
</html>
